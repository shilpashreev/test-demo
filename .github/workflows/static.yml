name: Playwright Tests & Dashboard History

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write    # Required for peaceiris to commit to gh-pages
  checks: write      # Required for dorny/test-reporter

jobs:
  build_and_report:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      checks: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # --- Setup ---
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
      
      - name: Install dependencies and browsers
        run: |
          npm ci
          npx playwright install --with-deps
          
      # --- Get Previous History (Required for Aggregation) ---
      - name: Download Previous Dashboard History
        uses: actions/checkout@v4
        with:
          ref: gh-pages # Checkout the gh-pages branch
          path: gh-pages-temp
          
      # --- Create Dashboard Directory & Copy History ---
      - name: Prepare Dashboard Directory
        run: |
          mkdir dashboard-output
          # Copy history file from gh-pages branch if it exists
          if [ -f gh-pages-temp/report_history.json ]; then
            cp gh-pages-temp/report_history.json dashboard-output/
          fi
          
      # --- Test Execution ---
      - name: Run Playwright tests and generate JSON report
        run: npx playwright test || true
        
      # --- Custom Dashboard Generation ---
      - name: Generate Historical Dashboard HTML
        # The script reads the new JSON, updates the history file, 
        # and creates index.html with charts in dashboard-output/
        run: node generate_dashboard.js

      # --- JUnit Report: Show Summary ---
      - name: Publish JUnit XML Report
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Playwright Test Results
          path: results/junit.xml
          reporter: jest-junit
          fail-on-error: true
          
      # --- Deploy Dashboard to gh-pages ---
      - name: Deploy Dashboard with History
        uses: peaceiris/actions-gh-pages@v4
        if: github.ref == 'refs/heads/main'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # The directory containing index.html and the history JSON
          publish_dir: ./dashboard-output 
          publish_branch: gh-pages
          # Overwrite the root of the gh-pages branch with the new dashboard
          destination_dir: .
